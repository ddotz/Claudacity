#!/bin/bash
#
# Pre-commit hook for Claudacity
# Runs SwiftLint and SwiftFormat on staged Swift files
#
# To install:
# cp Scripts/pre-commit .git/hooks/pre-commit
# chmod +x .git/hooks/pre-commit

set -e

echo "Running pre-commit checks..."

# Get list of staged Swift files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.swift$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo "No Swift files staged for commit."
    exit 0
fi

# Check if SwiftFormat is installed
if command -v swiftformat &> /dev/null; then
    echo "Formatting staged Swift files..."
    echo "$STAGED_FILES" | xargs swiftformat --config .swiftformat

    # Re-add formatted files to staging
    echo "$STAGED_FILES" | xargs git add
fi

# Check if SwiftLint is installed
if command -v swiftlint &> /dev/null; then
    echo "Running SwiftLint on staged Swift files..."

    # Lint only staged files
    LINT_RESULT=0
    while IFS= read -r file; do
        if [ -f "$file" ]; then
            swiftlint lint --config .swiftlint.yml --path "$file" --quiet || LINT_RESULT=1
        fi
    done <<< "$STAGED_FILES"

    if [ $LINT_RESULT -ne 0 ]; then
        echo ""
        echo "SwiftLint found issues. Please fix them before committing."
        echo "Run 'make lint-fix' to auto-fix some issues."
        exit 1
    fi
fi

echo "Pre-commit checks passed!"
exit 0
